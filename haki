--// ðŸ“œ Jungle Quest Auto System (Debug Print Edition)
--// Verbose real-time logs with print() for visibility
repeat task.wait() until game:IsLoaded()

print("[System] Game loaded, starting Jungle Quest automation...")

--====================================================
--// ðŸ´ Auto Select Team
--====================================================
local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

if playerGui:FindFirstChild("Main (minimal)") and playerGui["Main (minimal)"]:FindFirstChild("ChooseTeam") then
	print("[Team] Waiting for team selection menu...")
	repeat task.wait()
		local chooseGui = playerGui["Main (minimal)"].ChooseTeam
		if chooseGui.Visible then
			print("[Team] Choosing Pirates team...")
			for _, conn in pairs(getconnections(chooseGui.Container.Pirates.Frame.TextButton.Activated)) do
				for _, tap in pairs(getconnections(game:GetService("UserInputService").TouchTapInWorld)) do
					tap:Fire()
				end
				conn.Function()
			end
		end
	until player.Team ~= nil and game:IsLoaded()
	print("[Team] Team selected:", player.Team.Name)
end

--====================================================
--// âš™ï¸ Services
--====================================================
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Workspace = game:GetService("Workspace")

--====================================================
--// ðŸ§ Player Setup
--====================================================
local Character = player.Character or player.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")
local CommF_ = ReplicatedStorage.Remotes.CommF_

local CacheInventory = {}
local __NoClip = true

print("[Init] Character loaded:", Character.Name)

--====================================================
--// ðŸš« Noclip System
--====================================================
task.spawn(function()
	while task.wait(0.3) do
		local Char = player.Character
		if not Char then continue end

		for _, part in ipairs(Char:GetDescendants()) do
			if part:IsA("BasePart") then
				part.CanCollide = not __NoClip
			end
		end
	end
end)
print("[Noclip] Collision disabled.")

-- Maintain BodyVelocity / AngularVelocity
task.spawn(function()
	while task.wait(0.25) do
		pcall(function()
			local Char = player.Character
			if not Char then return end
			local torso = Char:FindFirstChild("UpperTorso")
			if not torso then return end

			if __NoClip then
				if not torso:FindFirstChildOfClass("BodyVelocity") then
					local bv = Instance.new("BodyVelocity")
					bv.Name = HttpService:GenerateGUID(false)
					bv.Velocity = Vector3.zero
					bv.MaxForce = Vector3.new(4000, 4000, 4000)
					bv.Parent = torso
				end

				if not torso:FindFirstChildOfClass("BodyAngularVelocity") then
					local bav = Instance.new("BodyAngularVelocity")
					bav.Name = HttpService:GenerateGUID(false)
					bav.AngularVelocity = Vector3.zero
					bav.MaxTorque = Vector3.new(4000, 4000, 4000)
					bav.Parent = torso
				end
			end
		end)
	end
end)

--====================================================
--// ðŸ”§ Utility Functions
--====================================================
local function touchButton(button)
	if button and button:IsA("BasePart") then
		print("[Touch] Touching button:", button.Name)
		firetouchinterest(button, HRP, 0)
		firetouchinterest(button, HRP, 1)
	end
end

local function getQuestState()
	local state = CommF_:InvokeServer("ProQuestProgress")
	print("[Quest] Current Quest State:", HttpService:JSONEncode(state))
	return state
end

local function invokeQuest(...)
	print("[Quest] Invoking:", ...)
	return CommF_:InvokeServer("ProQuestProgress", ...)
end

--====================================================
--// ðŸ§­ Tween Movement
--====================================================
local function Tween(target, instance)
	instance = instance or HRP
	local cf
	if typeof(target) == "Vector3" then
		cf = CFrame.new(target)
	elseif typeof(target) == "CFrame" then
		cf = target
	else
		return
	end
	local info = TweenInfo.new((cf.Position - instance.Position).Magnitude / 350, Enum.EasingStyle.Linear)
	local tween = TweenService:Create(instance, info, { CFrame = cf })
	tween:Play()
	print(("[Tween] Moving to position (%.1f, %.1f, %.1f)"):format(cf.X, cf.Y, cf.Z))
	return tween
end

local Tool = (function() 
	local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character
LocalPlayer.CharacterAdded:Connect(function(char)
	Character = char
end)
function EquipByToolTip(ToolTip)
	local Tool = Character:FindFirstChildOfClass("Tool")
	if Tool and Tool.ToolTip == ToolTip then
		return
	end

	for _, v in pairs(LocalPlayer.Backpack:GetChildren()) do
		if v.ToolTip == ToolTip then
			Character.Humanoid:EquipTool(v)
		end
	end
end

function EquipBest()
	EquipByToolTip("Melee")
end

function EquipWeapon(ToolSe)
	pcall(function()
		if
			Players.LocalPlayer.Backpack:FindFirstChild(ToolSe)
			and Players.LocalPlayer.Character:FindFirstChild("Humanoid")
		then
			local tool = Players.LocalPlayer.Backpack:FindFirstChild(ToolSe)
			wait()
			Players.LocalPlayer.Character.Humanoid:EquipTool(tool)
		end
	end)
end

return {
	EquipByToolTip = EquipByToolTip,
	EquipBest = EquipBest,
	EquipWeapon = EquipWeapon,
}

end)()

--====================================================
--// âš”ï¸ Combat Utilities
--====================================================
local CombatUtils = require(ReplicatedStorage.Modules.CombatUtil)
local Net = require(ReplicatedStorage.Modules.Net)
local gameFlags = require(ReplicatedStorage.Modules.Flags)

local RegisterHitEvent = Net:RemoteEvent("RegisterHit", true)
local RegisterAttack = Net:RemoteEvent("RegisterAttack")

local RegisterHitRemoteThread
for _, v in pairs(getgc()) do
	if typeof(v) == "function" and getfenv(v).script == ReplicatedStorage.Modules.CombatUtil then
		if gameFlags.COMBAT_REMOTE_THREAD and debug.getinfo(v).name == "registerHit" then
			RegisterHitRemoteThread = debug.getupvalue(v, 4)
		end
	end
end
print("[Combat] RegisterHit thread located:", tostring(RegisterHitRemoteThread ~= nil))

local AllTarget = {
	"RightUpperArm","RightLowerArm","RightHand",
	"RightUpperLeg","RightLowerLeg","RightFoot",
	"LeftUpperArm","LeftLowerArm","LeftHand",
	"LeftUpperLeg","LeftLowerLeg","LeftFoot",
	"UpperTorso","LowerTorso","HumanoidRootPart"
}

local function getWeaponName(instance)
	local tool = Character:FindFirstChildOfClass("Tool")
	if not tool then return end
	return instance and tool or (tool:GetAttribute("WeaponName") or tool.Name)
end

local function getCacheAim()
	local animCache = CombatUtils:GetMovesetAnimCache(Character.Humanoid)
	if not animCache then return end
	local weapon = getWeaponName()
	if not weapon then return end

	local weaponData = CombatUtils:GetWeaponData(weapon)
	local moves = weaponData.Moveset.Basic
	local index = math.random(1, #moves)
	local anim = animCache[weapon .. "-basic" .. index]
	anim:Play(0.1, 1, anim:GetAttribute("SpeedMult") or 1)
	print("[Combat] Attack animation:", weapon, "Basic index", index)
	return anim.Length
end

local function getAllBladeHits(radius)
	local hits = {}
	for _, enemy in ipairs(Workspace.Enemies:GetChildren()) do
		local hum = enemy:FindFirstChildOfClass("Humanoid")
		local target = enemy:FindFirstChild(AllTarget[math.random(1, #AllTarget)]) or enemy:FindFirstChild("HumanoidRootPart")
		if hum and target and hum.Health > 0 then
			local dist = (target.Position - HRP.Position).Magnitude
			if dist <= radius then
				table.insert(hits, target)
			end
		end
	end
	print("[Combat] Targets in range:", #hits)
	if #hits > 0 then
		return hits[1], {}
	end
	return nil, {}
end

local function AttackFunction()
	local first, multi = getAllBladeHits(120)
	local weapon = getWeaponName(true)
	if not first or not weapon then return end

	local anim = getCacheAim()
	if not anim then return end

	RegisterAttack:FireServer(anim)
	if gameFlags.COMBAT_REMOTE_THREAD and RegisterHitRemoteThread then
		coroutine.resume(RegisterHitRemoteThread, first, multi)
	else
		RegisterHitEvent:FireServer(first, multi)
	end
	print("[Combat] Attack executed on:", first.Parent.Name)
end

--====================================================
--// ðŸŒ¿ Step 1: Activate Jungle Plates
--====================================================
print("[Quest] Activating Jungle Plates...")
for _, model in pairs(Workspace.Map.Jungle.QuestPlates:GetChildren()) do
	if model:IsA("Model") and model:FindFirstChild("Button") then
		if model.Button.Color ~= Color3.fromRGB(58, 125, 21) then
			touchButton(model.Button)
		end
	end
end

--====================================================
--// ðŸ”¥ Step 2â€“5: Quest Sequence
--====================================================
local State = getQuestState()

-- Step 3: Torch
if not State.UsedTorch then
	print("[Quest] Starting torch phase...")
	invokeQuest("GetTorch")
	task.wait()
	invokeQuest("DestroyTorch")
	State = getQuestState()
end

-- Step 4: Cup
if not State.UsedCup then
	print("[Quest] Starting cup phase...")
	if not Character:FindFirstChild("Cup") and not player.Backpack:FindFirstChild("Cup") then
		invokeQuest("GetCup")
	end
	local cup = player.Backpack:FindFirstChild("Cup")
	if cup then Character.Humanoid:EquipTool(cup) end
	invokeQuest("FillCup", Character:FindFirstChild("Cup"))
	invokeQuest("SickMan")
	State = getQuestState()
end

-- Step 5: Mob Leader
if not State.KilledMob then
	print("[Quest] Fighting Mob Leader...")
	invokeQuest("RichSon")
	repeat
		task.wait()
		Tween(CFrame.new(-2852, 8, 5345))
		local mob = Workspace.Enemies:FindFirstChild("Mob Leader")
		if mob and mob:FindFirstChild("HumanoidRootPart") then
			Tween(mob.HumanoidRootPart.CFrame * CFrame.new(0, 30, 0))
			Tool.EquipBest()
			if not Character:FindFirstChild("HasBuso") then
				CommF_:InvokeServer("Buso")
			end
			AttackFunction()
		end
	until getQuestState().KilledMob
	invokeQuest("RichSon")
	print("[Quest] Mob Leader defeated!")
end

local ServerHop = (function()
	local PlaceID = game.PlaceId
local AllIDs = {}
local foundAnything = ""
local actualHour = os.date("!*t").hour
local File = pcall(function()
	AllIDs = game:GetService("HttpService"):JSONDecode(readfile("NotSameServers.json"))
end)
if not File then
	table.insert(AllIDs, actualHour)
	writefile("NotSameServers.json", game:GetService("HttpService"):JSONEncode(AllIDs))
end
function TPReturner()
	local Site
	if foundAnything == "" then
		Site = HttpService:JSONDecode(
			game:HttpGet("https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=1&limit=100")
		)
	else
		Site = HttpService:JSONDecode(
			game:HttpGet(
				"https://games.roblox.com/v1/games/"
					.. PlaceID
					.. "/servers/Public?sortOrder=1&limit=100&cursor="
					.. foundAnything
			)
		)
	end
	local ID = ""
	if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
		foundAnything = Site.nextPageCursor
	end
	local num = 0
	for i, v in pairs(Site.data) do
		local Possible = true
		ID = tostring(v.id)
		if tonumber(v.maxPlayers) > tonumber(v.playing) then
			for _, Existing in pairs(AllIDs) do
				if num ~= 0 then
					if ID == tostring(Existing) then
						Possible = false
					end
				else
					if tonumber(actualHour) ~= tonumber(Existing) then
						local delFile = pcall(function()
							delfile("NotSameServers.json")
							AllIDs = {}
							table.insert(AllIDs, actualHour)
						end)
					end
				end
				num = num + 1
			end
			if Possible == true then
				table.insert(AllIDs, ID)
				wait()
				pcall(function()
					writefile("NotSameServers.json", game:GetService("HttpService"):JSONEncode(AllIDs))
					wait()
					game:GetService("TeleportService"):TeleportToPlaceInstance(PlaceID, ID, Players.LocalPlayer)
				end)
				wait(4)
			end
		end
	end
end

function Teleport()
	while wait() do
		pcall(function()
			TPReturner()
			if foundAnything ~= "" then
				TPReturner()
			end
		end)
	end
end

return {
	ServerHOP = Teleport,
}

end)()




--====================================================
--// ðŸ—¿ Relic & Saber Expert
--====================================================
if not State.UsedRelic then
	print("[Relic] Placing Relic...")
	local relic = player.Backpack:FindFirstChild("Relic")
	if relic then Character.Humanoid:EquipTool(relic) end
	invokeQuest("PlaceRelic")
end

if not State.KilledShanks then
	print("[Boss] Searching for Saber Expert...")
	while not CacheInventory["Saber"] do
		task.wait()
		local expert = Workspace.Enemies:FindFirstChild("Saber Expert") or ReplicatedStorage:FindFirstChild("Saber Expert")
		if not expert then
			print("[Boss] Saber Expert not found, hopping server...")
			while not expert do 
				task.wait()
				expert = Workspace.Enemies:FindFirstChild("Saber Expert") or ReplicatedStorage:FindFirstChild("Saber Expert")
				ServerHop.ServerHOP()
				task.wait(6)
			end
		else
			print("[Boss] Found Saber Expert! Engaging...")
			if expert.Parent == ReplicatedStorage then
				Tween(expert.HumanoidRootPart.CFrame * CFrame.new(0, 30, 0))
				repeat task.wait() until Workspace.Enemies:FindFirstChild("Saber Expert")
			end
			local mob = Workspace.Enemies:FindFirstChild("Saber Expert")
			while mob and mob:FindFirstChild("HumanoidRootPart") and mob.Humanoid.Health > 0 do
				Tween(mob.HumanoidRootPart.CFrame * CFrame.new(0, 30, 0))
				if not Character:FindFirstChild("HasBuso") then
					CommF_:InvokeServer("Buso")
				end
				Tool.EquipBest()
				AttackFunction()
				task.wait()
			end
			print("[Boss] Saber Expert defeated!")
		end
	end
end

print("[System] Jungle Quest Automation Completed Successfully âœ…")
if game.ReplicatedStorage.Remotes.CommF_:InvokeServer("KenTalk", "Start") == 1 then 
	game.ReplicatedStorage.Remotes.CommF_:InvokeServer("KenTalk", "Buy")
end
